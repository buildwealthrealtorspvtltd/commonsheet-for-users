<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Property Data Table</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Global Scrollbar Hide --- */
        html { scrollbar-width: none; }
        body { -ms-overflow-style: none; }
        html::-webkit-scrollbar { display: none; }

        /* --- Modal Transition --- */
        #viewModal.hidden, #remarkModal.hidden, #mediaModal.hidden, #addPropertyModal.hidden, #loginScreen.hidden { display: none; }

        /* --- Utility class for other scrollable elements --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Loading Spinner --- */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .syncing-icon {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="bg-gray-100 p-4 sm:p-6 font-sans">

    <div id="loginScreen" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Property Portal Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginEmail" class="block text-gray-700 text-sm font-bold mb-2">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="Enter your registered email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button type="submit" id="loginButton" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    Login
                </button>
                 <p id="loginError" class="text-red-500 text-sm mt-2 text-center"></p>
            </form>
        </div>
    </div>

    <div id="mainAppContainer" class="hidden container mx-auto bg-white p-6 rounded-lg shadow-md">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
             <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Property Data</h1>
                <div id="userInfo" class="text-sm text-gray-600 mt-1">
                    Logged in as: <span id="userEmailDisplay" class="font-semibold text-indigo-700"></span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <button id="addPropertyBtn" class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Add New Property</button>
                 <button id="logoutButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Logout</button>
            </div>
        </div>

        <div class="flex items-center mb-4 gap-4">
            <input type="text" id="searchInput" placeholder="Search by any field..."
                   class="p-2 border border-gray-300 rounded w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <button id="syncBtn" class="p-2 border border-gray-300 rounded hover:bg-gray-100 transition" title="Sync with Google Sheet">
                <svg id="syncIcon" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4l-4 4M4 20l4-4M1 12h5M18 12h5"></path></svg>
            </button>
        </div>

        <div id="tableContainer" class="overflow-x-auto no-scrollbar">
            </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-4">
            <div class="flex items-center gap-2">
                <label for="rowsPerPage" class="text-sm text-gray-600">Rows per page:</label>
                <select id="rowsPerPage" class="p-1 border border-gray-300 rounded text-sm">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
            </div>
            <div class="flex items-center gap-2">
                <button id="prevPage"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition">Prev</button>
                <span id="pageInfo" class="text-sm text-gray-700"></span>
                <button id="nextPage"
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed transition">Next</button>
            </div>
        </div>
    </div>

    <div id="viewModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 id="modalTitle" class="text-xl font-bold text-gray-800">Property Details</h2>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="space-y-6 flex-grow overflow-y-auto">
            </div>
            <div class="flex justify-between items-center mt-6 pt-4 border-t">
                 <button id="deletePropertyButton" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                 <div class="space-x-2">
                     <button id="viewMediaButton" class="px-5 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 transition disabled:opacity-50 disabled:cursor-not-allowed">View Media</button>
                     <button id="addRemarkButton" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Add Remark</button>
                     <button id="editModalButton" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Edit</button>
                     <button id="closeModalButtonFooter" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Close</button>
                 </div>
            </div>
        </div>
    </div>
    
    <div id="addPropertyModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl h-screen flex flex-col">
             <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800">Add New Property</h2>
                <button id="closeAddPropertyModalButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <iframe id="googleFormFrame" class="w-full h-full" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe>
            </div>
        </div>
    </div>

    <div id="remarkModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Add/Edit Remark</h2>
            <textarea id="remarkTextarea" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500" rows="4" placeholder="Enter remarks..."></textarea>
            <div class="text-right mt-4 space-x-2">
                <button id="cancelRemarkButton" class="px-5 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">Cancel</button>
                <button id="saveRemarkButton" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Save Remark</button>
            </div>
        </div>
    </div>

    <div id="mediaModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Property Media</h2>
                <button id="closeMediaModalButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="mediaGrid" class="flex-grow overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
    </div>
    
    <div id="fullscreenViewer" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4">
        <img id="fullscreenImage" class="max-w-full max-h-full object-contain">
        <button id="closeFullscreenButton" class="absolute top-4 right-4 text-white text-4xl">&times;</button>
        <button id="prevImageButton" class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-4xl bg-black bg-opacity-30 p-2 rounded-full">&lt;</button>
        <button id="nextImageButton" class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-4xl bg-black bg-opacity-30 p-2 rounded-full">&gt;</button>
        <div id="imageCounter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white text-lg"></div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbxKPDF9JKUxRq3B3o3dQmNfOyRRcTurVxykqJSxw3AAevXGd_g-7zx5_AqeY1lsGV2p/exec";
        const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScGsdymqV-9Hg2UyLuUUVO9pLwvd9lSR0mmScB5cdg4Dp1Y5A/viewform?embedded=true";

        const fieldConfig = {
            id: { label: 'ID', section: 'System' },
            timestamp: { label: 'Timestamp', section: 'System' },
            emailAddress: { label: 'Email Address', section: 'System' },
            ownerName: { label: 'Owner Name', type: 'text', required: true, section: 'Owner & Contact' },
            ownerMobile: { label: 'Owner Mobile No.', type: 'tel', required: true, section: 'Owner & Contact' },
            ownerEmail: { label: 'Owner Email Id', type: 'email', section: 'Owner & Contact' },
            category: { label: 'Category', type: 'select', options: ['Residential', 'Commercial', 'Industrial', 'Land'], section: 'Property & Location' },
            propertyType: { label: 'Property Type', type: 'text', section: 'Property & Location' },
            city: { label: 'City', type: 'text', section: 'Property & Location' },
            locality: { label: 'Locality', type: 'text', section: 'Property & Location' },
            subLocality: { label: 'Sub Locality', type: 'text', section: 'Property & Location' },
            projectName: { label: 'Project Name', type: 'text', section: 'Property & Location' },
            unitNo: { label: 'Unit No.', type: 'text', section: 'Property & Location' },
            totalArea: { label: 'Total Area', type: 'text', section: 'Property & Location' },
            facing: { label: 'Facing', type: 'text', section: 'Property & Location' },
            approachRoadWidth: { label: 'Approach Road Width', type: 'text', section: 'Property & Location' },
            expectedSalePrice: { label: 'Expected Sale Price', type: 'text', section: 'Pricing & Value' },
            govtValue: { label: 'Govt Value', type: 'text', section: 'Pricing & Value' },
            tenure: { label: 'Freehold/Leasehold', type: 'select', options: ['Freehold', 'Leasehold'], section: 'Legal & Status' },
            status: { label: 'Status', type: 'select', options: ['Available', 'Sold', 'Rented', 'Pending'], section: 'Legal & Status' },
            registration: { label: 'Registration', type: 'select', options: ['Done', 'Pending', 'N/A'], section: 'Legal & Status' },
            mutation: { label: 'Mutation', type: 'select', options: ['Done', 'Pending', 'N/A'], section: 'Legal & Status' },
            construction: { label: 'Construction', type: 'select', options: ['Ready', 'Under Construction', 'N/A'], section: 'Legal & Status' },
            landUsage: { label: 'Land Usage', type: 'text', section: 'Legal & Status' },
            conversionStatus: { label: 'Conversion Status', type: 'select', options: ['Converted', 'Not Converted', 'N/A'], section: 'Legal & Status' },
            generatedBy: { label: 'Generated By', type: 'text', section: 'Additional Details' },
            clientRemarks: { label: 'Client Remarks', type: 'textarea', section: 'Additional Details' },
            upload: { label: 'UPLOAD', type: 'textarea', section: 'Additional Details' },
        };


        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let state = {
                currentUser: null,
                allData: [],
                filteredData: [],
                currentPage: 1,
                rowsPerPage: 10,
                lastFocusedElement: null,
                media: [],
                currentMediaIndex: 0,
                isSyncing: false,
                syncIntervalId: null, // <-- ID for the background sync interval
                get totalPages() {
                    return Math.ceil(this.filteredData.length / this.rowsPerPage);
                }
            };

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById("loginScreen");
            const loginForm = document.getElementById("loginForm");
            const loginEmailInput = document.getElementById("loginEmail");
            const loginError = document.getElementById("loginError");
            
            const mainAppContainer = document.getElementById("mainAppContainer");
            const userEmailDisplay = document.getElementById("userEmailDisplay");
            const logoutButton = document.getElementById("logoutButton");
            
            const tableContainer = document.getElementById("tableContainer");
            const searchInput = document.getElementById("searchInput");
            const rowsPerPageSelect = document.getElementById("rowsPerPage");
            const pageInfo = document.getElementById("pageInfo");
            const prevPageBtn = document.getElementById("prevPage");
            const nextPageBtn = document.getElementById("nextPage");
            const syncBtn = document.getElementById("syncBtn");
            const syncIcon = document.getElementById("syncIcon");
            
            const modal = document.getElementById("viewModal");
            const modalContent = document.getElementById("modalContent");
            const closeModalButton = document.getElementById("closeModalButton");
            const closeModalButtonFooter = document.getElementById("closeModalButtonFooter");
            const editModalButton = document.getElementById("editModalButton");
            const addRemarkButton = document.getElementById("addRemarkButton");
            const viewMediaButton = document.getElementById("viewMediaButton");
            const deletePropertyButton = document.getElementById("deletePropertyButton");

            const addPropertyModal = document.getElementById("addPropertyModal");
            const googleFormFrame = document.getElementById("googleFormFrame");
            const closeAddPropertyModalButton = document.getElementById("closeAddPropertyModalButton");
            const addPropertyBtn = document.getElementById("addPropertyBtn");

            const remarkModal = document.getElementById("remarkModal");
            const remarkTextarea = document.getElementById("remarkTextarea");
            const saveRemarkButton = document.getElementById("saveRemarkButton");
            const cancelRemarkButton = document.getElementById("cancelRemarkButton");

            const mediaModal = document.getElementById("mediaModal");
            const mediaGrid = document.getElementById("mediaGrid");
            const closeMediaModalButton = document.getElementById("closeMediaModalButton");

            const fullscreenViewer = document.getElementById("fullscreenViewer");
            const fullscreenImage = document.getElementById("fullscreenImage");
            const closeFullscreenButton = document.getElementById("closeFullscreenButton");
            const prevImageButton = document.getElementById("prevImageButton");
            const nextImageButton = document.getElementById("nextImageButton");
            const imageCounter = document.getElementById("imageCounter");

            // --- LOGIN / LOGOUT & SESSION ---
            
            const showLoginScreen = () => {
                loginScreen.classList.remove('hidden');
                mainAppContainer.classList.add('hidden');
                loginEmailInput.focus();
            };
            
            const showAppScreen = () => {
                loginScreen.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                userEmailDisplay.textContent = state.currentUser;
                fetchData(); // Initial data fetch
                
                // --- START BACKGROUND SYNC ---
                if (state.syncIntervalId) clearInterval(state.syncIntervalId); // Clear any old interval
                state.syncIntervalId = setInterval(() => {
                    fetchData(true); // Sync in the background
                }, 5000); // Sync every 5 seconds
            };
            
            const handleLogin = (e) => {
                e.preventDefault();
                const email = loginEmailInput.value.trim().toLowerCase();
                if (!email) {
                    loginError.textContent = "Email address cannot be empty.";
                    return;
                }
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                    loginError.textContent = "Please enter a valid email address.";
                    return;
                }
                loginError.textContent = "";
                state.currentUser = email;
                sessionStorage.setItem('currentUserEmail', email);
                showAppScreen();
            };
            
            const handleLogout = () => {
                // --- STOP BACKGROUND SYNC ON LOGOUT ---
                if (state.syncIntervalId) {
                    clearInterval(state.syncIntervalId);
                    state.syncIntervalId = null;
                }

                state.currentUser = null;
                state.allData = [];
                state.filteredData = [];
                sessionStorage.removeItem('currentUserEmail');
                tableContainer.innerHTML = '';
                pageInfo.textContent = '';
                showLoginScreen();
            };
            
            const checkLoginStatus = () => {
                const user = sessionStorage.getItem('currentUserEmail');
                if (user) {
                    state.currentUser = user;
                    showAppScreen();
                } else {
                    showLoginScreen();
                }
            };
            
            // --- UTILITY & API FUNCTIONS ---
            const debounce = (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(this, args), delay);
                };
            };

            async function apiCall(action, data = {}) {
                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify({ action, data }),
                        redirect: 'follow'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'API operation failed.');
                    }
                    return result.data;
                } catch (error) {
                    console.error('API Call Error:', error);
                    alert(`Error: ${error.message}`);
                    throw error;
                }
            }
            
            async function fetchData(isBackground = false) {
                if (state.isSyncing || !state.currentUser) return;
                state.isSyncing = true;
                
                if (!isBackground) {
                    showLoadingState();
                } else {
                    syncIcon.classList.add('syncing-icon');
                }
                syncBtn.disabled = true;

                try {
                    const response = await fetch(API_ENDPOINT);
                    if (!response.ok) throw new Error('Failed to fetch data');
                    const result = await response.json();
                    if (result.success) {
                        const allUserData = result.data || [];
                        state.allData = allUserData.filter(item => item.emailAddress && item.emailAddress.toLowerCase() === state.currentUser)
                                                 .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        refreshView();
                    } else {
                        throw new Error(result.message || 'Failed to load data from API');
                    }
                } catch (error) {
                    if (!isBackground) {
                        showErrorState(error.message);
                    } else {
                        console.error("Background sync failed: " + error.message); // Log silently for background sync
                    }
                } finally {
                    state.isSyncing = false;
                    syncIcon.classList.remove('syncing-icon');
                    syncBtn.disabled = false;
                }
            }


            // --- UI STATE FUNCTIONS ---
            function showLoadingState() {
                tableContainer.innerHTML = `<div class="flex justify-center items-center p-10"><div class="loader"></div></div>`;
            }

            function showErrorState(message) {
                tableContainer.innerHTML = `<div class="text-center p-10 text-red-500">${message}</div>`;
            }

            // --- RENDER FUNCTIONS (Unchanged from original logic, now operates on filtered data) ---
            const renderTable = () => {
                let tableHTML = `
                    <table class="min-w-full bg-white rounded-lg shadow">
                        <thead class="bg-blue-600 text-white">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">Owner Name</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">Property Type</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">City</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">Project Name</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">Sale Price</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">Status</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">Remarks</th>
                                <th class="py-3 px-4 text-left text-sm font-semibold uppercase">View</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
                    </table>`;
                tableContainer.innerHTML = tableHTML;
                const tableBody = document.getElementById("tableBody");

                const start = (state.currentPage - 1) * state.rowsPerPage;
                const end = start + state.rowsPerPage;
                const paginatedData = state.filteredData.slice(start, end);

                if (paginatedData.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 8;
                    cell.className = 'text-center py-4 px-4 text-gray-500';
                    cell.textContent = 'No matching records found for your account.';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    return;
                }

                paginatedData.forEach((item) => {
                    const row = document.createElement("tr");
                    row.dataset.itemId = item.id; 
                    
                    const createCell = (text, customClasses = 'whitespace-nowrap') => {
                        const cell = document.createElement('td');
                        cell.className = `py-2 px-4 ${customClasses}`;
                        cell.textContent = text || 'N/A';
                        return cell;
                    };

                    row.appendChild(createCell(item.ownerName));
                    row.appendChild(createCell(item.propertyType));
                    row.appendChild(createCell(item.city));
                    row.appendChild(createCell(item.projectName));
                    row.appendChild(createCell(item.expectedSalePrice));
                    row.appendChild(createCell(item.status));
                    row.appendChild(createCell(item.clientRemarks, 'whitespace-normal break-words max-w-xs'));
                    
                    const actionCell = document.createElement('td');
                    actionCell.className = 'py-2 px-4';
                    const viewButton = document.createElement('button');
                    viewButton.className = 'bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition view-btn';
                    viewButton.textContent = 'View';
                    actionCell.appendChild(viewButton);
                    row.appendChild(actionCell);

                    tableBody.appendChild(row);
                });
            };
            
            const updatePagination = () => {
                pageInfo.textContent = `Page ${state.currentPage} of ${state.totalPages || 1}`;
                prevPageBtn.disabled = state.currentPage === 1;
                nextPageBtn.disabled = state.currentPage === state.totalPages || state.totalPages === 0;
            };

            const refreshView = () => {
                const searchTerm = searchInput.value.toLowerCase();
                state.filteredData = state.allData.filter(item =>
                    Object.entries(item).some(([key, val]) =>
                        fieldConfig[key]?.section !== 'System' && String(val).toLowerCase().includes(searchTerm)
                    )
                );
                renderTable();
                updatePagination();
            };

            // --- MODAL FUNCTIONS (All original logic is preserved) ---
            const populateModalView = (item) => {
                modalContent.innerHTML = '';
                const sections = {};

                for (const key in item) {
                    const config = fieldConfig[key];
                    if (config && config.section !== 'System') {
                        if (!sections[config.section]) sections[config.section] = [];
                        sections[config.section].push({ key, value: item[key], label: config.label });
                    }
                }

                for (const sectionTitle in sections) {
                    const sectionDiv = document.createElement('div');
                    const titleEl = document.createElement('h3');
                    titleEl.className = 'text-lg font-semibold text-gray-700 mb-2 col-span-full border-b';
                    titleEl.textContent = sectionTitle;
                    sectionDiv.appendChild(titleEl);

                    const gridDiv = document.createElement('div');
                    gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2';
                    
                    sections[sectionTitle].forEach(({ key, value, label }) => {
                        const keyDiv = document.createElement('div');
                        keyDiv.className = 'font-semibold text-gray-600';
                        keyDiv.textContent = label + ':';

                        const valueDiv = document.createElement('div');
                        valueDiv.className = 'text-gray-800 break-words';
                        valueDiv.textContent = value || 'N/A';
                        
                        gridDiv.appendChild(keyDiv);
                        gridDiv.appendChild(valueDiv);
                    });

                    sectionDiv.appendChild(gridDiv);
                    modalContent.appendChild(sectionDiv);
                }
            }

            const openModal = (item) => {
                modal.dataset.itemId = item.id;
                modalContent.classList.remove('edit-mode');
                editModalButton.textContent = 'Edit';
                editModalButton.classList.replace('bg-yellow-500', 'bg-green-600');
                addRemarkButton.disabled = false;
                editModalButton.disabled = false;
                viewMediaButton.disabled = !item.upload;
                
                populateModalView(item);
                modal.classList.remove("hidden");

                state.lastFocusedElement = document.activeElement;
                closeModalButton.focus();
            };

            const closeModal = () => {
                modal.classList.add("hidden");
                if (state.lastFocusedElement) state.lastFocusedElement.focus();
            };

            // --- EVENT HANDLERS (All original logic is preserved) ---
            const handleFilter = debounce(() => {
                state.currentPage = 1;
                refreshView();
            }, 300);
            
            const handleEditClick = () => {
                const isEditMode = modalContent.classList.toggle('edit-mode');
                const itemId = modal.dataset.itemId;
                const item = state.allData.find(p => p.id == itemId);

                if (isEditMode) {
                    editModalButton.textContent = 'Save';
                    editModalButton.classList.replace('bg-green-600', 'bg-yellow-500');
                    addRemarkButton.disabled = true;
                    viewMediaButton.disabled = true;
                    deletePropertyButton.disabled = true;

                    modalContent.innerHTML = '';
                    const sections = {};

                    for (const key in fieldConfig) {
                        const config = fieldConfig[key];
                        if (config.type) { 
                             if (!sections[config.section]) sections[config.section] = [];
                            sections[config.section].push({ key, ...config });
                        }
                    }

                    for (const sectionTitle in sections) {
                        const sectionDiv = document.createElement('div');
                        const titleEl = document.createElement('h3');
                        titleEl.className = 'text-lg font-semibold text-gray-700 mb-2 col-span-full border-b';
                        titleEl.textContent = sectionTitle;
                        sectionDiv.appendChild(titleEl);

                        const gridDiv = document.createElement('div');
                        gridDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3';

                        sections[sectionTitle].forEach(config => {
                            const value = item[config.key];
                            const keyDiv = document.createElement('label');
                            keyDiv.className = 'font-semibold text-gray-600 flex items-center';
                            keyDiv.textContent = config.label + ':';
                            keyDiv.htmlFor = `edit-${config.key}`;
                            
                            let inputElement;
                            if (config.type === 'textarea') {
                                inputElement = document.createElement('textarea');
                                inputElement.rows = 2;
                                inputElement.value = value || '';
                            } else if (config.type === 'select') {
                                inputElement = document.createElement('select');
                                config.options.forEach(opt => {
                                    const option = document.createElement('option');
                                    option.value = opt;
                                    option.textContent = opt;
                                    if (opt == value) option.selected = true;
                                    inputElement.appendChild(option);
                                });
                            } else {
                                inputElement = document.createElement('input');
                                inputElement.type = config.type || 'text';
                                inputElement.value = value || '';
                                if (config.required) inputElement.required = true;
                            }
                            
                            inputElement.name = config.key;
                            inputElement.id = `edit-${config.key}`;
                            inputElement.className = 'p-2 border border-gray-300 rounded w-full text-sm bg-white';
                            
                            gridDiv.appendChild(keyDiv);
                            gridDiv.appendChild(inputElement);
                        });
                        sectionDiv.appendChild(gridDiv);
                        modalContent.appendChild(sectionDiv);
                    }

                } else {
                    const formElements = modalContent.querySelectorAll('input, select, textarea');
                    const updatedItemData = { id: itemId };
                    let isValid = true;
                    formElements.forEach(el => {
                        if (el.required && !el.value) {
                            el.classList.add('border-red-500');
                            isValid = false;
                        } else {
                             el.classList.remove('border-red-500');
                        }
                        updatedItemData[el.name] = el.value;
                    });

                    if (!isValid) {
                        alert('Please fill all required fields.');
                        modalContent.classList.add('edit-mode'); 
                        return;
                    }
                    
                    editModalButton.textContent = 'Saving...';
                    editModalButton.disabled = true;

                    apiCall('updateProperty', updatedItemData)
                        .then(updatedData => {
                            const itemIndex = state.allData.findIndex(p => p.id == itemId);
                            state.allData[itemIndex] = updatedData;
                            populateModalView(updatedData);
                            refreshView();

                            addRemarkButton.disabled = false;
                            viewMediaButton.disabled = !updatedData.upload;
                            deletePropertyButton.disabled = false;

                            editModalButton.textContent = 'Saved!';
                            setTimeout(() => {
                                editModalButton.textContent = 'Edit';
                                editModalButton.classList.replace('bg-yellow-500', 'bg-green-600');
                                editModalButton.disabled = false;
                            }, 1500);
                        })
                        .catch(() => {
                            alert('Failed to save changes.');
                            modalContent.classList.add('edit-mode'); // Revert to edit mode on failure
                            editModalButton.textContent = 'Save';
                            editModalButton.disabled = false;
                        });
                }
            };
            
            const handleAddRemarkClick = () => {
                const itemId = modal.dataset.itemId;
                const item = state.allData.find(p => p.id == itemId);
                remarkTextarea.value = item.clientRemarks || "";
                
                remarkModal.dataset.itemId = itemId;
                remarkModal.classList.remove('hidden');
                remarkTextarea.focus();
            };

            const handleSaveRemarkClick = async () => {
                const itemId = remarkModal.dataset.itemId;
                const newRemark = remarkTextarea.value;
                
                saveRemarkButton.textContent = "Saving...";
                saveRemarkButton.disabled = true;

                try {
                    const updatedData = await apiCall('updateProperty', { id: itemId, clientRemarks: newRemark });
                    const itemIndex = state.allData.findIndex(p => p.id == itemId);
                    state.allData[itemIndex] = updatedData;
                    
                    populateModalView(updatedData);
                    remarkModal.classList.add('hidden');
                    refreshView();
                } catch (error) {
                    alert('Failed to save remark.');
                } finally {
                    saveRemarkButton.textContent = "Save Remark";
                    saveRemarkButton.disabled = false;
                }
            };

            const handleDeleteClick = async () => {
                const itemId = modal.dataset.itemId;
                if (!confirm(`Are you sure you want to delete this property (ID: ${itemId})? This action cannot be undone.`)) {
                    return;
                }

                deletePropertyButton.textContent = "Deleting...";
                deletePropertyButton.disabled = true;

                try {
                    await apiCall('deleteProperty', { id: itemId });
                    state.allData = state.allData.filter(p => p.id != itemId);
                    closeModal();
                    refreshView();
                } catch (error) {
                    alert('Failed to delete property.');
                } finally {
                    deletePropertyButton.textContent = "Delete";
                    deletePropertyButton.disabled = false;
                }
            };

            const handleViewMediaClick = () => {
                const itemId = modal.dataset.itemId;
                const item = state.allData.find(p => p.id == itemId);
                if (!item || !item.upload) return;

                mediaGrid.innerHTML = ''; 
                state.media = [];
                const urls = item.upload.split(',');

                urls.forEach((urlStr, index) => {
                    const trimmedUrl = urlStr.trim();
                    if (!trimmedUrl) return;

                    try {
                        const idMatch = trimmedUrl.match(/id=([a-zA-Z0-9_-]+)/);
                        if (idMatch && idMatch[1]) {
                            const id = idMatch[1];
                            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${id}`;
                            const fullUrl = `https://drive.google.com/thumbnail?id=${id}&sz=w1280-h720`; // High-res thumbnail
                            state.media.push({ thumbnail: thumbnailUrl, full: fullUrl });

                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'aspect-square bg-gray-200 rounded-lg overflow-hidden cursor-pointer';
                            imgContainer.dataset.index = index;
                            const img = document.createElement('img');
                            img.src = thumbnailUrl;
                            img.alt = 'Property Media';
                            img.className = 'w-full h-full object-cover';
                            img.onerror = () => {
                                img.alt = 'Image not available';
                                img.src = `https://placehold.co/400x400/e2e8f0/4a5568?text=Preview+Not+Available`;
                            };
                            imgContainer.appendChild(img);
                            mediaGrid.appendChild(imgContainer);
                        }
                    } catch (e) {
                        console.error("Invalid URL string:", trimmedUrl);
                    }
                });

                mediaModal.classList.remove('hidden');
            };

            const showFullscreenImage = (index) => {
                state.currentMediaIndex = index;
                fullscreenImage.src = state.media[index].full;
                fullscreenImage.onerror = () => {
                    fullscreenImage.alt = 'Full-size image not available';
                    fullscreenImage.src = `https://placehold.co/1280x720/e2e8f0/4a5568?text=Preview+Not+Available`;
                };

                imageCounter.textContent = `${index + 1} / ${state.media.length}`;
                
                if (state.media.length > 1) {
                    prevImageButton.classList.remove('hidden');
                    nextImageButton.classList.remove('hidden');
                } else {
                    prevImageButton.classList.add('hidden');
                    nextImageButton.classList.add('hidden');
                }

                fullscreenViewer.classList.remove('hidden');
                document.addEventListener('keydown', handleKeydown);
            };

            const handleKeydown = (e) => {
                if (fullscreenViewer.classList.contains('hidden')) return;
                if (e.key === 'ArrowRight') showNextImage();
                if (e.key === 'ArrowLeft') showPrevImage();
                if (e.key === 'Escape') closeFullscreenViewer();
            };

            const showNextImage = () => {
                if(state.media.length <= 1) return;
                const newIndex = (state.currentMediaIndex + 1) % state.media.length;
                showFullscreenImage(newIndex);
            };

            const showPrevImage = () => {
                if(state.media.length <= 1) return;
                const newIndex = (state.currentMediaIndex - 1 + state.media.length) % state.media.length;
                showFullscreenImage(newIndex);
            };
            
            const closeFullscreenViewer = () => {
                fullscreenViewer.classList.add('hidden');
                document.removeEventListener('keydown', handleKeydown);
            };
            
            const handleTableClick = (e) => {
                const viewButton = e.target.closest('.view-btn');
                if (viewButton) {
                    const row = viewButton.closest('tr');
                    const itemId = row.dataset.itemId;
                    const itemData = state.allData.find(p => p.id == itemId);
                    if(itemData) openModal(itemData);
                }
            };

            const openAddPropertyModal = () => {
                googleFormFrame.src = GOOGLE_FORM_URL;
                addPropertyModal.classList.remove('hidden');
            };
            
            const closeAddPropertyModal = () => {
                addPropertyModal.classList.add('hidden');
                fetchData(true); // Trigger background sync
            };

            // --- EVENT LISTENERS ---
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            
            searchInput.addEventListener("input", handleFilter);
            rowsPerPageSelect.addEventListener("change", (e) => { state.rowsPerPage = parseInt(e.target.value, 10); state.currentPage = 1; refreshView(); });
            prevPageBtn.addEventListener("click", () => { if (state.currentPage > 1) { state.currentPage--; refreshView(); } });
            nextPageBtn.addEventListener("click", () => { if (state.currentPage < state.totalPages) { state.currentPage++; refreshView(); } });
            tableContainer.addEventListener('click', handleTableClick);
            editModalButton.addEventListener('click', handleEditClick);
            addRemarkButton.addEventListener('click', handleAddRemarkClick);
            viewMediaButton.addEventListener('click', handleViewMediaClick);
            deletePropertyButton.addEventListener('click', handleDeleteClick);
            addPropertyBtn.addEventListener('click', openAddPropertyModal);
            syncBtn.addEventListener('click', () => fetchData(false));

            closeModalButton.addEventListener('click', closeModal);
            closeModalButtonFooter.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

            saveRemarkButton.addEventListener('click', handleSaveRemarkClick);
            cancelRemarkButton.addEventListener('click', () => remarkModal.classList.add('hidden'));

            closeMediaModalButton.addEventListener('click', () => mediaModal.classList.add('hidden'));
            mediaModal.addEventListener('click', (e) => { if (e.target === mediaModal) mediaModal.classList.add('hidden'); });
            mediaGrid.addEventListener('click', (e) => {
                const container = e.target.closest('[data-index]');
                if (container) showFullscreenImage(parseInt(container.dataset.index, 10));
            });

            closeFullscreenButton.addEventListener('click', closeFullscreenViewer);
            nextImageButton.addEventListener('click', showNextImage);
            prevImageButton.addEventListener('click', showPrevImage);
            
            closeAddPropertyModalButton.addEventListener('click', closeAddPropertyModal);

            // --- INITIALIZATION ---
            checkLoginStatus();
        });
    </script>
</body>

</html>
